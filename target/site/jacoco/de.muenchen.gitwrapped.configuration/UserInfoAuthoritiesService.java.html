<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>UserInfoAuthoritiesService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">gitwrapped-backend</a> &gt; <a href="index.source.html" class="el_package">de.muenchen.gitwrapped.configuration</a> &gt; <span class="el_source">UserInfoAuthoritiesService.java</span></div><h1>UserInfoAuthoritiesService.java</h1><pre class="source lang-java linenums">package de.muenchen.gitwrapped.configuration;

import com.github.benmanes.caffeine.cache.Caffeine;
import com.github.benmanes.caffeine.cache.Ticker;
import java.util.ArrayList;
import java.util.Collection;
import java.util.List;
import java.util.Map;
import java.util.concurrent.TimeUnit;
import java.util.stream.Stream;
import lombok.extern.slf4j.Slf4j;
import org.springframework.boot.web.client.RestTemplateBuilder;
import org.springframework.cache.Cache;
import org.springframework.cache.Cache.ValueWrapper;
import org.springframework.cache.caffeine.CaffeineCache;
import org.springframework.http.HttpEntity;
import org.springframework.http.HttpHeaders;
import org.springframework.http.HttpMethod;
import org.springframework.security.core.GrantedAuthority;
import org.springframework.security.core.authority.SimpleGrantedAuthority;
import org.springframework.security.oauth2.jwt.Jwt;
import org.springframework.util.ObjectUtils;
import org.springframework.web.client.RestTemplate;

/**
 * Service that calls an OIDC /userinfo endpoint (with JWT Bearer Auth) and extracts the
 * &quot;Authorities&quot; contained there.
 */
<span class="nc" id="L29">@Slf4j</span>
public class UserInfoAuthoritiesService {

    private static final String NAME_AUTHENTICATION_CACHE = &quot;authentication_cache&quot;;
    private static final int AUTHENTICATION_CACHE_ENTRY_SECONDS_TO_EXPIRE = 60;

    private static final String CLAIM_AUTHORITIES = &quot;authorities&quot;;

    private final String userInfoUri;
    private final RestTemplate restTemplate;
    private final Cache cache;

    /**
     * Creates a new instance
     *
     * @param userInfoUri userinfo endpoint URI
     * @param restTemplateBuilder a {@link RestTemplateBuilder}
     */
<span class="nc" id="L47">    public UserInfoAuthoritiesService(final String userInfoUri, final RestTemplateBuilder restTemplateBuilder) {</span>
<span class="nc" id="L48">        this.userInfoUri = userInfoUri;</span>
<span class="nc" id="L49">        this.restTemplate = restTemplateBuilder.build();</span>
<span class="nc" id="L50">        this.cache = new CaffeineCache(NAME_AUTHENTICATION_CACHE,</span>
<span class="nc" id="L51">                Caffeine.newBuilder()</span>
<span class="nc" id="L52">                        .expireAfterWrite(AUTHENTICATION_CACHE_ENTRY_SECONDS_TO_EXPIRE, TimeUnit.SECONDS)</span>
<span class="nc" id="L53">                        .ticker(Ticker.systemTicker())</span>
<span class="nc" id="L54">                        .build());</span>
<span class="nc" id="L55">    }</span>

    /**
     * Calls the /userinfo endpoint and extracts {@link GrantedAuthority}s from the &quot;authorities&quot; claim.
     *
     * @param jwt the JWT
     * @return the {@link GrantedAuthority}s according to claim &quot;authorities&quot; of /userinfo endpoint
     */
    public Collection&lt;SimpleGrantedAuthority&gt; loadAuthorities(final Jwt jwt) {
<span class="nc" id="L64">        final ValueWrapper valueWrapper = this.cache.get(jwt.getSubject());</span>
<span class="nc bnc" id="L65" title="All 2 branches missed.">        if (valueWrapper != null) {</span>
            // value present in cache
            @SuppressWarnings(&quot;unchecked&quot;)
<span class="nc" id="L68">            final Collection&lt;SimpleGrantedAuthority&gt; authorities = (Collection&lt;SimpleGrantedAuthority&gt;) valueWrapper.get();</span>
<span class="nc" id="L69">            log.debug(&quot;Resolved authorities (from cache): {}&quot;, authorities);</span>
<span class="nc" id="L70">            return authorities;</span>
        }

<span class="nc" id="L73">        log.debug(&quot;Fetching user-info for token subject: {}&quot;, jwt.getSubject());</span>
        @SuppressWarnings(&quot;PMD.LooseCoupling&quot;)
<span class="nc" id="L75">        final HttpHeaders headers = new HttpHeaders();</span>
<span class="nc" id="L76">        headers.set(HttpHeaders.AUTHORIZATION, &quot;Bearer &quot; + jwt.getTokenValue());</span>
<span class="nc" id="L77">        final HttpEntity&lt;String&gt; entity = new HttpEntity&lt;&gt;(headers);</span>

<span class="nc" id="L79">        Collection&lt;SimpleGrantedAuthority&gt; authorities = new ArrayList&lt;&gt;();</span>
        try {
            @SuppressWarnings(&quot;unchecked&quot;)
<span class="nc" id="L82">            final Map&lt;String, Object&gt; map = restTemplate.exchange(this.userInfoUri, HttpMethod.GET, entity,</span>
<span class="nc" id="L83">                    Map.class).getBody();</span>

<span class="nc" id="L85">            log.debug(&quot;Response from user-info Endpoint: {}&quot;, map);</span>
<span class="nc bnc" id="L86" title="All 4 branches missed.">            if (map != null &amp;&amp; map.containsKey(CLAIM_AUTHORITIES)) {</span>
<span class="nc" id="L87">                authorities = asAuthorities(map.get(CLAIM_AUTHORITIES));</span>
            }
<span class="nc" id="L89">            log.debug(&quot;Resolved Authorities (from /userinfo Endpoint): {}&quot;, authorities);</span>
            // store
<span class="nc" id="L91">            this.cache.put(jwt.getSubject(), authorities);</span>
<span class="nc" id="L92">        } catch (Exception e) {</span>
<span class="nc" id="L93">            log.error(String.format(&quot;Could not fetch user details from %s - user is granted NO authorities&quot;,</span>
                    this.userInfoUri), e);
<span class="nc" id="L95">        }</span>

<span class="nc" id="L97">        return authorities;</span>
    }

    private static List&lt;SimpleGrantedAuthority&gt; asAuthorities(final Object object) {
<span class="nc" id="L101">        final List&lt;SimpleGrantedAuthority&gt; authorities = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L102">        Object authoritiesObject = object;</span>
<span class="nc bnc" id="L103" title="All 2 branches missed.">        if (authoritiesObject instanceof Collection) {</span>
<span class="nc" id="L104">            final Collection&lt;?&gt; collection = (Collection&lt;?&gt;) authoritiesObject;</span>
<span class="nc" id="L105">            authoritiesObject = collection.toArray(new Object[0]);</span>
        }
<span class="nc bnc" id="L107" title="All 2 branches missed.">        if (ObjectUtils.isArray(authoritiesObject)) {</span>
<span class="nc" id="L108">            authorities.addAll(</span>
<span class="nc" id="L109">                    Stream.of((Object[]) authoritiesObject)</span>
<span class="nc" id="L110">                            .map(Object::toString)</span>
<span class="nc" id="L111">                            .map(SimpleGrantedAuthority::new)</span>
<span class="nc" id="L112">                            .toList());</span>
        }
<span class="nc" id="L114">        return authorities;</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.13.202504020838</span></div></body></html>